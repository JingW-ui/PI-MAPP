# 🎬 监控快照功能说明

## 功能概述

监控快照功能已重新设计，现在与实时监控tab紧密结合使用。该功能能够自动保存检测到目标的视频片段，并以MP4格式存储，同时保存详细的检测统计信息。

## 主要特性

### 🔄 自动保存机制
- **智能触发**: 只有在检测到目标时才保存视频帧
- **摄像头分离**: 每个摄像头独立录制，按摄像头名和时间命名
- **实时保存**: 检测到目标时立即开始录制，无目标时停止

### 💾 存储格式
- **视频文件**: MP4格式，标准视频编码
- **元数据文件**: JSON格式，包含检测统计、时间信息等
- **存储位置**: `monitor_history/` 目录

### 🧠 内存管理
- **内存限制**: 默认500MB，可调整
- **自动清理**: 超过限制时自动删除最旧的记录
- **智能管理**: 按时间排序，优先保留最新记录

## 使用方法

### 1. 启动监控
1. 在"实时监控"标签页选择模型
2. 选择要监控的摄像头
3. 点击"🚀 开始监控"

### 2. 启用自动保存
1. 监控启动后，"🎬 自动保存监控快照"按钮变为可用
2. 点击按钮开始自动保存
3. 按钮变为"⏹️ 停止自动保存"，表示正在录制

### 3. 配置参数
- **帧率**: 默认20fps，范围5-60fps
- **内存限制**: 默认500MB，范围100-2000MB

### 4. 查看快照
1. 切换到"🎬 监控快照"标签页
2. 查看快照历史列表
3. 选择快照进行播放或删除

## 文件命名规则

### 视频文件
```
摄像头名_时间戳.mp4
例如: 摄像头0_1703123456.mp4
```

### 元数据文件
```
摄像头名_时间戳.json
例如: 摄像头0_1703123456.json
```

## 快照信息显示

每个快照显示以下信息：
- **摄像头名称**: 标识来源摄像头
- **时间范围**: 开始和结束时间
- **文件大小**: MP4文件大小
- **检测次数**: 总检测次数
- **检测统计**: 各类别检测次数

## 技术实现

### 核心组件
- **MonitoringWidget**: 集成自动保存控制
- **CameraVideoRecorder**: 单摄像头录制器
- **SnapshotWidget**: 快照显示和播放

### 录制流程
1. 检测到目标时创建录制器
2. 按设定帧率保存视频帧
3. 统计检测信息
4. 达到时长限制时自动保存
5. 检查内存使用，必要时清理

### 内存管理
- 实时监控磁盘使用量
- 超过限制时删除25%的最旧记录
- 保证新记录能够正常保存

## 测试方法

运行测试脚本：
```bash
python ui_test/monitor_snapshot_test.py
```

测试脚本提供：
- 模拟检测数据生成
- 功能验证界面
- 实时状态监控

## 注意事项

1. **存储空间**: 确保有足够的磁盘空间
2. **性能影响**: 录制会增加CPU和磁盘使用
3. **文件管理**: 定期清理不需要的历史记录
4. **网络存储**: 建议将monitor_history目录放在快速存储设备上

## 故障排除

### 常见问题
1. **录制不启动**: 检查是否选择了模型和摄像头
2. **文件过大**: 调整内存限制或降低帧率
3. **播放失败**: 检查MP4文件是否完整
4. **内存不足**: 减少内存限制或清理旧文件

### 日志信息
程序会在控制台输出录制状态信息：
```
保存监控快照: 摄像头0 - 600 帧, 15 次检测
```

## 更新日志

### v2.0 (当前版本)
- 重新设计为与实时监控集成
- 改为MP4+JSON存储格式
- 添加内存管理机制
- 优化用户界面

### v1.0 (已废弃)
- 独立的录制功能
- JSON格式存储
- 手动控制录制